{% extends "base/dashboard_base.html" %}

{% block title %}Cases ‚Äì propER{% endblock %}

{% block main_content %}
<div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 28px;">
    <div>
        <h2 style="font-size:2.2rem;font-weight:800;margin-bottom:4px;letter-spacing:-1.2px;">Cases</h2>
        <div style="color:#7e8a97;font-size:1.13rem;margin-bottom:2px;">All registered cases. Filter, search, and manage.</div>
    </div>
    <a href="{{ url_for('cases.add') }}" class="action-btn btn-success" style="font-size:1.07rem;"><i class="fas fa-plus"></i> Add Case</a>
</div>

<div style="background:#fff;padding:26px 26px 10px 26px;border-radius:18px;box-shadow:0 6px 32px rgba(67,97,238,0.10);margin-bottom:36px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <input id="caseSearch" type="text" placeholder="Search cases..." style="border:1.2px solid #d2e2fa;border-radius:7px;padding:9px 13px;width:260px;font-size:1.1rem;">
        <!-- <button class="btn-primary" style="font-size:1.01rem;padding:8px 16px;border:none;border-radius:7px;">Export</button> -->
    </div>
    <style>
    .case-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px 30px;
    }
    .field-group {
    display: flex;
    flex-direction: column;
    }
    .field-label {
    font-weight: 600;
    color: #7c82a1;
    margin-bottom: 6px;
    font-size: 0.95rem;
    }
    .field-box {
    padding: 12px;
    border-radius: 8px;
    background: #f5f7ff;
    border: 1px solid #dce3f0;
    color: #222;
    font-size: 1.07rem;
    }
    @media (max-width: 768px) {
    .case-grid {
        grid-template-columns: 1fr;
    }
    }
    </style>

    <div style="overflow-x:auto;">
    <table id="casesTable" style="width:100%;border-collapse:collapse;font-size:1.06rem;">
        <thead>
            <tr style="background:#f4f8fb;">
                <th style="padding:11px 14px;text-align:left;font-weight:700;color:#4361ee;">#</th>
                <th style="padding:11px 14px;text-align:left;">Case No</th>
                <th style="padding:11px 14px;text-align:left;">Case Details</th>
                <th style="padding:11px 14px;text-align:left;">Status</th>
                <th style="padding:11px 14px;text-align:left;">Generate</th>
                <th style="padding:11px 14px;text-align:left;">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% if cases %}
            {% for case in cases %}
            <tr class="case-row" style="border-bottom:1.2px solid #e9eefa;">
                <td style="padding:10px 14px;font-weight:700;color:#888;">{{ case.number }}</td>
                <td style="padding:10px 14px;">{{ case.case_no }}</td>
                <td style="padding:10px 14px;">{{ case.description }}</td>
                <td style="padding:10px 14px;">
                    {% if case.case_status == 'SUBMIT' %}
                        <span style="background:#d0e7ff;color:#007bff;padding:5px 14px;font-weight:700;border-radius:6px;">SUBMIT</span>
                    {% elif case.case_status == 'IN PROGRESS' %}
                        <span style="background:#fff3cd;color:#856404;padding:5px 14px;font-weight:700;border-radius:6px;">IN PROGRESS</span>
                    {% elif case.case_status == 'SETTLE' %}
                        <span style="background:#d4edda;color:#28a745;padding:5px 14px;font-weight:700;border-radius:6px;">SETTLE</span>
                    {% elif case.case_status == 'KIV' %}
                        <span style="background:#fff0d0;color:#b49108;padding:5px 14px;font-weight:700;border-radius:6px;">KIV</span>
                    {% elif case.case_status == 'CANCEL' %}
                        <span style="background:#f8d7da;color:#dc3545;padding:5px 14px;font-weight:700;border-radius:6px;">CANCEL</span>
                    {% else %}
                        <span style="background:#e2e3e5;color:#6c757d;padding:5px 14px;font-weight:700;border-radius:6px;">{{ case.case_status or '-' }}</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('cases.generate_invoice', case_id=case['case_id']) }}" 
                    class="action-btn btn-info" 
                    style="padding:4px 15px 4px 10px; font-size:0.98rem; margin-top:3px; margin-right:7px; display:inline-block;">
                        <i class="fas fa-file-invoice"></i> Invoice
                    </a>
                    <a href="{{ url_for('cases.generate_receipt', case_id=case['case_id']) }}" 
                    class="action-btn btn-primary" 
                    style="padding:4px 15px 4px 10px; font-size:0.98rem; margin-top:3px; display:inline-block;">
                        <i class="fas fa-receipt"></i> Receipt
                    </a>
                </td>
                <td style="padding:10px 14px;">
                    <!-- View -->
                    <a href="#" data-bs-toggle="modal" data-bs-target="#viewModal{{ case.case_id }}" title="View" style="margin-right:7px;color:#4361ee;"><i class="fas fa-eye"></i></a>
                    <!-- Edit -->
                    <a href="#" data-bs-toggle="modal" data-bs-target="#editModal{{ case.case_id }}" title="Edit" style="margin-right:7px;color:#14b8a6;"><i class="fas fa-edit"></i></a>
                    <!-- Delete -->
                    <a href="#" data-bs-toggle="modal" data-bs-target="#deleteModal{{ case.case_id }}" title="Delete" style="color:#f72585;"><i class="fas fa-trash"></i></a>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr><td colspan="6" style="text-align:center;padding:33px 0;color:#aaa;font-weight:600;">No cases found.</td></tr>
        {% endif %}
        </tbody>
    </table>
    </div>
    {% for case in cases %}
    <!-- View Modal -->
    <div class="modal fade" id="viewModal{{ case.case_id }}" tabindex="-1">
    <div class="modal-dialog modal-lg" style="max-width: 960px;">
        <div class="modal-content" style="border-radius: 18px;">
        <div class="modal-header">
            <h5 class="modal-title" style="font-size: 2.2rem; font-weight: 800; color: #4361ee;"><i class="fas fa-file-alt"></i> View Case</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="padding: 48px 50px; background: #f7f8fd; font-family: 'Poppins', Arial, sans-serif;">
            <div class="case-grid">

                <!-- üîπ SECTION: DETAILS -->
                <h4 style="grid-column: span 2; font-weight: bold; color: #4361ee;">üìù Case Details</h4>
                {% for field in ['number', 'case_no', 'invoice_no', 'eform_id', 'agent_id', 'leader_id', 'agent_name', 'leader_name', 'client_name', 'property_address', 'description', 'case_details'] %}
                <div class="field-group">
                    <label class="field-label">{{ field.replace('_', ' ') | title }}</label>
                    <input class="field-box" type="text" name="{{ field }}" value="{{ case[field] }}">
                </div>
                {% endfor %}

                <!-- üîπ SECTION: INVOICE -->
                <h4 style="grid-column: span 2; font-weight: bold; color: #4361ee; margin-top: 24px;">üßæ Invoice Info</h4>
                {% for field in ['purchase_price', 'amount', 'fee_pct', 'commission_pct', 'commission_total', 'override_leader_amt', 'override_hoa_amt', 'profit_proper', 'ed_amount', 'ed_paid', 'ed_pending', 'tax', 'total_amount'] %}
                <div class="field-group">
                    <label class="field-label">{{ field.replace('_', ' ') | title }}</label>
                    <input class="field-box" type="text" name="{{ field }}" value="{{ case[field] }}">
                </div>
                {% endfor %}

                <!-- üîπ SECTION: RECEIPT -->
                <h4 style="grid-column: span 2; font-weight: bold; color: #4361ee; margin-top: 24px;">üìÑ Receipt Info</h4>
                {% for field in ['reference_no', 'registration_no', 'mode_of_payment', 'in_part_payment_of', 'date_created', 'payment_status'] %}
                <div class="field-group">
                    <label class="field-label">{{ field.replace('_', ' ') | title }}</label>
                    <input class="field-box" type="text" name="{{ field }}" value="{{ case[field] }}">
                </div>
                {% endfor %}

                <!-- üîπ Case Status Dropdown -->
                <div class="field-group">
                <label class="field-label">Case Status</label>
                <select class="field-box" name="case_status">
                    {% for option in ['SUBMIT', 'IN PROGRESS', 'SETTLE', 'KIV', 'CANCEL'] %}
                    <option value="{{ option }}" {% if case.case_status == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
                </div>

            </div>
        </div>
        <div class="modal-footer" style="padding: 16px 24px;">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
        </div>
    </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal{{ case.case_id }}" tabindex="-1">
    <div class="modal-dialog modal-lg" style="max-width: 960px;">
        <form class="modal-content" action="{{ url_for('cases.edit', case_id=case.case_id) }}" method="post" style="border-radius: 18px;">
        <div class="modal-header">
            <h5 class="modal-title" style="font-size: 2.2rem; font-weight: 800; color: #4361ee;"><i class="fas fa-edit"></i> Edit Case</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
                <div class="modal-body" style="padding: 48px 50px; background: #f7f8fd; font-family: 'Poppins', Arial, sans-serif;">
            <div class="case-grid">

                <!-- üîπ SECTION: DETAILS -->
                <h4 style="grid-column: span 2; font-weight: bold; color: #4361ee;">üìù Case Details</h4>
                {% for field in ['number', 'case_no', 'invoice_no', 'eform_id', 'agent_id', 'leader_id', 'agent_name', 'leader_name', 'client_name', 'property_address', 'description', 'case_details'] %}
                <div class="field-group">
                    <label class="field-label">{{ field.replace('_', ' ') | title }}</label>
                    <input class="field-box" type="text" name="{{ field }}" value="{{ case[field] }}">
                </div>
                {% endfor %}

                <!-- üîπ SECTION: INVOICE -->
                <h4 style="grid-column: span 2; font-weight: bold; color: #4361ee; margin-top: 24px;">üßæ Invoice Info</h4>
                {% for field in ['purchase_price', 'amount', 'fee_pct', 'commission_pct', 'commission_total', 'override_leader_amt', 'override_hoa_amt', 'profit_proper', 'ed_amount', 'ed_paid', 'ed_pending', 'tax', 'total_amount'] %}
                <div class="field-group">
                    <label class="field-label">{{ field.replace('_', ' ') | title }}</label>
                    <input class="field-box" type="text" name="{{ field }}" value="{{ case[field] }}">
                </div>
                {% endfor %}

                <!-- üîπ SECTION: RECEIPT -->
                <h4 style="grid-column: span 2; font-weight: bold; color: #4361ee; margin-top: 24px;">üìÑ Receipt Info</h4>
                {% for field in ['reference_no', 'registration_no', 'mode_of_payment', 'in_part_payment_of', 'date_created', 'payment_status'] %}
                <div class="field-group">
                    <label class="field-label">{{ field.replace('_', ' ') | title }}</label>
                    <input class="field-box" type="text" name="{{ field }}" value="{{ case[field] }}">
                </div>
                {% endfor %}

                <!-- üîπ Case Status Dropdown -->
                <div class="field-group">
                <label class="field-label">Case Status</label>
                <select class="field-box" name="case_status">
                    {% for option in ['SUBMIT', 'IN PROGRESS', 'SETTLE', 'KIV', 'CANCEL'] %}
                    <option value="{{ option }}" {% if case.case_status == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
                </div>

            </div>
        </div>
        <div class="modal-footer" style="padding: 16px 24px;">
            <button class="btn btn-primary" type="submit">Save</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
        </form>
    </div>
    </div>


    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal{{ case.case_id }}" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" action="{{ url_for('cases.delete', case_id=case.case_id) }}" method="post">
        <div class="modal-header"><h5 class="modal-title">Delete Case</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            Are you sure you want to delete this case: <b>{{ case.client_name }}</b>?
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" type="submit">Delete</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
        </form>
    </div>
    </div>
    {% endfor %}
</div>

<script>
// Live search
document.getElementById('caseSearch').addEventListener('input', function() {
    const q = this.value.toLowerCase();
    document.querySelectorAll('#casesTable tbody tr').forEach(tr => {
        if (tr.innerText.toLowerCase().indexOf(q) > -1) tr.style.display = '';
        else tr.style.display = 'none';
    });
});
</script>
{% endblock %}
