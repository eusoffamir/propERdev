{% extends "base/dashboard_base.html" %}
{% block title %}Pending Requests â€“ propER{% endblock %}

{% block main_content %}
<div class="center-card" style="margin:38px auto;background:#fff;border-radius:22px;box-shadow:0 8px 40px #4361ee18, 0 2px 10px #e9ecef44;padding:48px 38px 38px 38px;position:relative;">

  <div class="logo-bar" style="display:flex;align-items:center;margin-bottom:24px;">
    <img src="{{ url_for('static', filename='logo_left.png') }}" alt="propER Logo" style="width:54px;height:54px;margin-right:18px;">
    <span class="logo-bar-title" style="font-size:2.2rem;font-weight:800;color:#4361ee;letter-spacing:0.5px;">Pending Registration Requests</span>
    <button class="exit-btn" onclick="window.location.href='{{ url_for('dashboard.index') }}'" title="Back to Dashboard" style="position:absolute;top:26px;right:26px;background:none;border:none;color:#adb5bd;font-size:1.6rem;cursor:pointer;transition:color .18s;"><i class="fas fa-arrow-left"></i></button>
  </div>

  {% if reqs|length == 0 %}
  <div style="margin:26px 0 0;text-align:center;color:#999;">
    <i class="fas fa-check-circle" style="color:#51cf66;font-size:2.5rem;margin-bottom:8px;"></i>
    <div>No pending registration requests.</div>
  </div>
  {% else %}
  <div style="width:100%;overflow-x:auto;">
    <table style="min-width:700px;width:100%;border-collapse:separate;border-spacing:0 6px;font-size:1.07rem;background:#fff;">
      <thead>
        <tr style="background:#f5f7ff;font-weight:700;color:#222;font-size:1.06rem;">
          <th style="text-align:left;padding:16px 18px;">Name</th>
          <th style="text-align:left;padding:16px 18px;">Email</th>
          <th style="text-align:left;padding:16px 18px;">NRIC</th>
          <th style="text-align:left;padding:16px 18px;">Team</th>
          <th style="text-align:center;padding:16px 18px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for req in reqs %}
        <tr style="box-shadow:0 2px 10px #dbe5fa23;">
          <td style="background:#fff;padding:16px 18px;">{{ req.name }}</td>
          <td style="background:#fff;padding:16px 18px;">{{ req.email }}</td>
          <td style="background:#fff;padding:16px 18px;">{{ req.nric }}</td>
          <td style="background:#fff;padding:16px 18px;">
            {% if user_role == 'Admin' %}
              <form action="{{ url_for('users.approve_request', request_id=req.request_id) }}" method="post" style="display:inline;">
                <select name="team" style="margin-right:8px;padding:4px 8px;border-radius:6px;border:1px solid #ccc;">
                  <option value="HQ" {% if req.team == 'HQ' %}selected{% endif %}>HQ</option>
                  <option value="AZIMI" {% if req.team == 'AZIMI' %}selected{% endif %}>AZIMI</option>
                  <option value="INDRA" {% if req.team == 'INDRA' %}selected{% endif %}>INDRA</option>
                  <option value="AARC" {% if req.team == 'AARC' %}selected{% endif %}>AARC</option>
                  <option value="PEA" {% if req.team == 'PEA' %}selected{% endif %}>PEA</option>
                  <option value="NON-STAFF" {% if req.team == 'NON-STAFF' %}selected{% endif %}>NON-STAFF</option>
                </select>
                <button type="submit" style="white-space:nowrap;background:#51cf66;color:#fff;font-weight:600;padding:6px 14px;border-radius:8px;border:none;font-size:0.95rem;">
                  <i class="fas fa-check"></i> Approve
                </button>
              </form>
            {% else %}
              {{ req.team or '-' }}
            {% endif %}
          </td>
          <td style="background:#fff;padding:16px 18px;">
            <div style="display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto;justify-content:center;">
              <form action="{{ url_for('users.reject_request', request_id=req.request_id) }}" method="post">
                <button type="submit" style="white-space:nowrap;background:#fa5252;color:#fff;font-weight:600;padding:6px 14px;border-radius:8px;border:none;font-size:0.95rem;">
                  <i class="fas fa-times"></i> Reject
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <div style="font-size:1.25rem;font-weight:700;margin:30px 0 12px 0;color:#22223b;display:flex;align-items:center;">
    <i class="fas fa-users" style="margin-right:12px;color:#4895ef;"></i>Active Users
  </div>

  {% set allowed_teams = ['HQ', 'AZIMI', 'INDRA', 'AARC', 'PEA', 'NON-STAFF'] %}
  {% set all_teams = ['All'] + allowed_teams + ['None'] %}
  {% set teams = {} %}
  {% for user in users %}
    {% set t = user.team if user.team in allowed_teams else 'None' %}
    {% if t not in teams %}
      {% set _ = teams.update({t: []}) %}
    {% endif %}
    {% set _ = teams[t].append(user) %}
  {% endfor %}

  <!-- Team Tabs -->
  <div id="teamTabs" style="display:flex;gap:10px;margin-bottom:18px;">
    {% for team in all_teams %}
      <button class="team-tab-btn" onclick="showTeamTab('{{ team }}')" id="tab-btn-{{ team }}" style="padding:8px 22px;border:none;border-radius:8px 8px 0 0;background:#f5f7fa;color:#4361ee;font-weight:700;font-size:1.08rem;cursor:pointer;outline:none;">{{ team }} <span style="color:#888;font-size:0.98rem;">({{ users|length if team == 'All' else (teams[team]|length if teams[team] is defined else 0) }})</span></button>
    {% endfor %}
  </div>

  <!-- Team Tab Contents -->
  <div id="teamTabContents">
    {% for team in all_teams %}
      <div class="team-tab-content" id="tab-content-{{ team }}" style="display:none;">
        <div style="margin-bottom:10px;font-size:1.13rem;font-weight:700;color:#4361ee;">{{ team }} <span style="color:#888;font-size:1.01rem;">({{ users|length if team == 'All' else (teams[team]|length if teams[team] is defined else 0) }} members)</span></div>
        <div style="width:100%;overflow-x:auto;">
          <table style="min-width:700px;width:100%;border-collapse:separate;border-spacing:0 6px;font-size:1.07rem;background:#fff;">
            <thead>
              <tr style="background:#f5f7ff;font-weight:700;color:#222;font-size:1.06rem;">
                <th style="text-align:left;padding:16px 18px;">Name</th>
                <th style="text-align:left;padding:16px 18px;">Email</th>
                <th style="text-align:left;padding:16px 18px;">Role</th>
                <th style="text-align:left;padding:16px 18px;">Team</th>
                <th style="text-align:left;padding:16px 18px;">Last Login</th>
                <th style="text-align:center;padding:16px 18px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if team == 'All' %}
                {% for user in users %}
                  <tr style="box-shadow:0 2px 10px #dbe5fa23;">
                    <td style="background:#fff;padding:16px 18px;">
                      <span onclick="showUserDetails({{ user.user_id }})" style="color:#4361ee;cursor:pointer;text-decoration:underline;font-weight:600;">{{ user.name }}</span>
                    </td>
                    <td style="background:#fff;padding:16px 18px;">{{ user.email }}</td>
                    <td style="background:#fff;padding:16px 18px;">
                      {% if user.role == "Admin" %}
                        <span style="border-radius:8px;font-size:1.05rem;font-weight:700;padding:6px 18px;background:#f72585;color:#fff;">Admin</span>
                      {% elif user.role == "Leader" %}
                        <span style="border-radius:8px;font-size:1.05rem;font-weight:700;padding:6px 18px;background:#4895ef;color:#fff;">Leader</span>
                      {% else %}
                        <span style="border-radius:8px;font-size:1.05rem;font-weight:700;padding:6px 18px;background:#4cc9f0;color:#222;">Agent</span>
                      {% endif %}
                    </td>
                    <td style="background:#fff;padding:16px 18px;">{{ user.team or '-' }}</td>
                    <td style="background:#fff;padding:16px 18px;color:#666;">{{ user.last_login or "-" }}</td>
                    <td style="background:#fff;padding:16px 18px;text-align:center;">
                      <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                          <button onclick="showUserDetails({{ user.user_id }})" title="Details"
                          style="width:36px;height:36px;display:flex;justify-content:center;align-items:center;
                                  background:#edf2fb;color:#4361ee;border-radius:8px;border:none;cursor:pointer;">
                          <i class="fas fa-eye"></i>
                          </button>
                          <button onclick="showUserEdit({{ user.user_id }})" title="Edit"
                          style="width:36px;height:36px;display:flex;justify-content:center;align-items:center;
                                  background:#ffd60a;color:#22223b;border-radius:8px;border:none;cursor:pointer;">
                          <i class="fas fa-pen"></i>
                          </button>
                          {% if user.role != "Admin" %}
                          <form action="{{ url_for('users.remove', user_id=user.user_id) }}" method="post"
                                  onsubmit="return confirm('Are you sure you want to remove this user?');"
                                  style="display:inline;">
                              <button type="submit" title="Remove"
                                      style="width:36px;height:36px;display:flex;justify-content:center;align-items:center;
                                          background:#fa5252;color:#fff;border:none;border-radius:8px;">
                              <i class="fas fa-trash"></i>
                              </button>
                          </form>
                          {% else %}
                          <span title="Admin cannot be removed"
                                  style="width:36px;height:36px;display:flex;justify-content:center;align-items:center;
                                      color:#adb5bd;border-radius:8px;">
                              <i class="fas fa-ban"></i>
                          </span>
                          {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                {% for user in teams[team] if teams[team] is defined %}
                  <tr style="box-shadow:0 2px 10px #dbe5fa23;">
                    <td style="background:#fff;padding:16px 18px;">
                      <span onclick="showUserDetails({{ user.user_id }})" style="color:#4361ee;cursor:pointer;text-decoration:underline;font-weight:600;">{{ user.name }}</span>
                    </td>
                    <td style="background:#fff;padding:16px 18px;">{{ user.email }}</td>
                    <td style="background:#fff;padding:16px 18px;">
                      {% if user.role == "Admin" %}
                        <span style="border-radius:8px;font-size:1.05rem;font-weight:700;padding:6px 18px;background:#f72585;color:#fff;">Admin</span>
                      {% elif user.role == "Leader" %}
                        <span style="border-radius:8px;font-size:1.05rem;font-weight:700;padding:6px 18px;background:#4895ef;color:#fff;">Leader</span>
                      {% else %}
                        <span style="border-radius:8px;font-size:1.05rem;font-weight:700;padding:6px 18px;background:#4cc9f0;color:#222;">Agent</span>
                      {% endif %}
                    </td>
                    <td style="background:#fff;padding:16px 18px;">{{ user.team or '-' }}</td>
                    <td style="background:#fff;padding:16px 18px;color:#666;">{{ user.last_login or "-" }}</td>
                    <td style="background:#fff;padding:16px 18px;text-align:center;">
                      <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                          <button onclick="showUserDetails({{ user.user_id }})" title="Details"
                          style="width:36px;height:36px;display:flex;justify-content:center;align-items:center;
                                  background:#edf2fb;color:#4361ee;border-radius:8px;border:none;cursor:pointer;">
                          <i class="fas fa-eye"></i>
                          </button>
                          <button onclick="showUserEdit({{ user.user_id }})" title="Edit"
                          style="width:36px;height:36px;display:flex;justify-content:center;align-items:center;
                                  background:#ffd60a;color:#22223b;border-radius:8px;border:none;cursor:pointer;">
                          <i class="fas fa-pen"></i>
                          </button>
                          {% if user.role != "Admin" %}
                          <form action="{{ url_for('users.remove', user_id=user.user_id) }}" method="post"
                                  onsubmit="return confirm('Are you sure you want to remove this user?');"
                                  style="display:inline;">
                              <button type="submit" title="Remove"
                                      style="width:36px;height:36px;display:flex;justify-content:center;align-items:center;
                                          background:#fa5252;color:#fff;border:none;border-radius:8px;">
                              <i class="fas fa-trash"></i>
                              </button>
                          </form>
                          {% else %}
                          <span title="Admin cannot be removed"
                                  style="width:36px;height:36px;display:flex;justify-content:center;align-items:center;
                                      color:#adb5bd;border-radius:8px;">
                              <i class="fas fa-ban"></i>
                          </span>
                          {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    function showTeamTab(team) {
      // Hide all tab contents
      document.querySelectorAll('.team-tab-content').forEach(function(tab) {
        tab.style.display = 'none';
      });
      // Remove active style from all tab buttons
      document.querySelectorAll('.team-tab-btn').forEach(function(btn) {
        btn.style.background = '#f5f7fa';
        btn.style.color = '#4361ee';
      });
      // Show selected tab
      document.getElementById('tab-content-' + team).style.display = 'block';
      // Highlight selected tab button
      document.getElementById('tab-btn-' + team).style.background = '#4361ee';
      document.getElementById('tab-btn-' + team).style.color = '#fff';
    }
    // Show first tab by default
    document.addEventListener('DOMContentLoaded', function() {
      showTeamTab('{{ all_teams[0] }}');
    });
  </script>
</div>

<!-- User Details/Edit Modal -->
<div id="userModal" class="modal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
  <div class="modal-content" style="background:#fff;padding:2rem 2.5rem;border-radius:16px;max-width:480px;width:100%;position:relative;min-height:200px;">
    <span class="close" onclick="closeUserModal()" style="position:absolute;top:18px;right:24px;font-size:2rem;cursor:pointer;">&times;</span>
    <div id="modalBody">
      <!-- Content loaded by JS -->
    </div>
  </div>
</div>

<script>
function openUserModal(contentHtml) {
  document.getElementById('modalBody').innerHTML = contentHtml;
  document.getElementById('userModal').style.display = 'flex';
}
function closeUserModal() {
  document.getElementById('userModal').style.display = 'none';
}

function showUserDetails(userId) {
  fetch(`/user/${userId}?modal=1`)
    .then(resp => resp.text())
    .then(html => openUserModal(html));
}

function showUserEdit(userId) {
  fetch(`/edit_user/${userId}?modal=1`)
    .then(resp => resp.text())
    .then(html => openUserModal(html));
}

function submitUserEdit(event, userId) {
  event.preventDefault();
  const form = document.getElementById('editUserForm');
  const data = Object.fromEntries(new FormData(form).entries());
  fetch(`/api/user/${userId}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(resp => resp.json())
  .then(res => {
    if(res.success){
      closeUserModal();
      location.reload();
    } else {
      alert(res.error||'Failed to update user.');
    }
  });
  return false;
}
</script>
{% endblock %}

<style>
.modal {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  background: rgba(30,40,90,0.18) !important;
  z-index: 9999 !important;
}
.modal-content {
  margin: 0 !important;
  position: static !important;
  left: unset !important;
  top: unset !important;
  transform: none !important;
}
</style>
